---

import siteData from "../../data/siteData.json"
import jsonLDGenerator, { generateWebSiteSchema, generateServiceSchema } from "../../data/jsonLD";

const {
  title = siteData.title,
  description = siteData.description,
  url = import.meta.env.SITE,
  image = siteData.image,
  robots = "index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1",
  canonical = url,
  article = null,
  service = null,
  type = 'Organization',
  keywords = siteData.keywords,
  author = siteData.company.name,
  publishedTime = null,
  modifiedTime = null
} = Astro.props;   


const organizationSchema = jsonLDGenerator({
  title,
  description,
  url,
  image,
  type,
  services: siteData.services
});

// Ensure jsonLDGenerator actually returns *object*, not string
// If it returns a string, parse it

const websiteSchema = generateWebSiteSchema({
  url: import.meta.env.SITE,
  searchUrl: `${import.meta.env.SITE}/search`,
  name: siteData.title
});

// Combine schema into one array
const combinedSchema:any = [organizationSchema, websiteSchema];

// Add service schema
if (service) {
  const serviceSchema = generateServiceSchema({
    serviceName: service.name,
    description: service.description,
    url: url,
    priceRange: service.priceRange || "$$$",
    provider: {
      "@type": "Organization",
      "name": siteData.company.name
    }
  });

  combinedSchema.push(serviceSchema);
}

// Convert combined schema to JSON-LD script
const jsonLD = JSON.stringify(combinedSchema, null, 2);

---

<!-- Primary Meta Tags -->
<title>{title}</title>
<meta name="title" content={title} />
<meta name="description" content={description} />
<meta name="keywords" content={keywords} />
<meta name="author" content={author} />
<meta name="robots" content={robots} />
<link rel="canonical" href={canonical} />

<!-- Open Graph / Facebook -->
<meta property="og:type" content={article ? "article" : "website"} />
<meta property="og:site_name" content={siteData.company.name} />
<meta property="og:locale" content="en_ZA" />
<meta property="og:title" content={title} />
<meta property="og:description" content={description} />
<meta property="og:url" content={url} />
<meta property="og:image" content={`${url}${image.src}`} />
<meta property="og:image:alt" content={image.alt} />
<meta property="og:image:type" content="image/png" />
<meta property="og:image:width" content={image.width || "1200"} />
<meta property="og:image:height" content={image.height || "630"} />
<meta property="og:updated_time" content={new Date().toISOString()} />

{article && (
  <>
    <meta property="article:published_time" content={publishedTime} />
    <meta property="article:modified_time" content={modifiedTime} />
    <meta property="article:author" content={author} />
    <meta property="article:section" content={article.section} />
    {article.tags && article.tags.map((tag:any) => (
      <meta property="article:tag" content={tag} />
    ))}
  </>
)}

<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content={siteData.social.twitter} />
<meta name="twitter:creator" content={siteData.social.twitter} />
<meta name="twitter:title" content={title} />
<meta name="twitter:description" content={description} />
<meta name="twitter:image" content={`${url}${image.src}`} />
<meta name="twitter:image:alt" content={image.alt} />
<meta name="twitter:domain" content={new URL(url).hostname} />

<!-- Additional Meta Tags -->
<meta name="language" content="English" />
<meta name="geo.region" content="ZA" />
<meta name="geo.position" content="-26.2041;28.0473" /> <!-- Johannesburg coordinates -->
<meta name="ICBM" content="-26.2041, 28.0473" />
<meta name="revisit-after" content="7 days" />

<!-- Structured Data -->
<script type="application/ld+json" set:html={jsonLD}></script>

<!-- Preload critical assets -->
<link rel="preload" href={image.src} as="image" />